---
export interface Props {
  placeholder?: string;
  className?: string;
}

const { placeholder = 'Search notes...', className = '' } = Astro.props;
---

<div class={`relative ${className}`}>
  <div class="relative">
    <!-- Search input -->
    <input
      type="text"
      id="search-input"
      placeholder={placeholder}
      class="w-full px-4 py-3 pl-12 pr-4 text-[var(--fg)] bg-[var(--bg)] border border-[var(--muted)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent transition-colors"
      autocomplete="off"
    />

    <!-- Search icon -->
    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
      <svg class="w-5 h-5 text-[var(--fg)] opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
    </div>

    <!-- Clear button -->
    <button
      id="search-clear"
      class="absolute inset-y-0 right-0 pr-3 flex items-center text-[var(--fg)] opacity-60 hover:opacity-100 transition-opacity hidden"
      aria-label="Clear search"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>

  <!-- Search results -->
  <div id="search-results" class="absolute top-full left-0 right-0 mt-2 bg-[var(--bg)] border border-[var(--muted)] rounded-lg shadow-lg z-50 hidden max-h-96 overflow-y-auto">
    <div id="search-loading" class="p-4 text-center text-[var(--fg)] opacity-60 hidden">
      <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-[var(--accent)] mr-2"></div>
      Searching...
    </div>
    <div id="search-no-results" class="p-4 text-center text-[var(--fg)] opacity-60 hidden">
      No results found.
    </div>
    <div id="search-results-list" class="divide-y divide-[var(--muted)]"></div>
  </div>
</div>

<script>
  // Search functionality will be initialized when search index is loaded
  window.searchBox = {
    input: document.getElementById('search-input'),
    clear: document.getElementById('search-clear'),
    results: document.getElementById('search-results'),
    loading: document.getElementById('search-loading'),
    noResults: document.getElementById('search-no-results'),
    resultsList: document.getElementById('search-results-list'),

    showResults() {
      this.results?.classList.remove('hidden');
    },

    hideResults() {
      this.results?.classList.add('hidden');
    },

    showLoading() {
      this.loading?.classList.remove('hidden');
      this.noResults?.classList.add('hidden');
      this.resultsList && (this.resultsList.innerHTML = '');
    },

    hideLoading() {
      this.loading?.classList.add('hidden');
    },

    showNoResults() {
      this.loading?.classList.add('hidden');
      this.noResults?.classList.remove('hidden');
      this.resultsList && (this.resultsList.innerHTML = '');
    },

    displayResults(results) {
      this.hideLoading();
      if (results.length === 0) {
        this.showNoResults();
        return;
      }

      this.noResults?.classList.add('hidden');
      this.resultsList && (this.resultsList.innerHTML = results.map(result => `
        <div class="p-3 hover:bg-[var(--muted)] transition-colors">
          <a href="/notes/${result.slug}" class="block">
            <h4 class="font-medium text-[var(--fg)] hover:text-[var(--accent)] transition-colors">
              ${result.title}
            </h4>
            ${result.description ? `
              <p class="text-sm text-[var(--fg)] opacity-70 mt-1 line-clamp-2">
                ${result.description}
              </p>
            ` : ''}
            ${result.tags && result.tags.length > 0 ? `
              <div class="flex flex-wrap gap-1 mt-2">
                ${result.tags.slice(0, 3).map(tag => `<span class="inline-block px-2 py-1 text-xs bg-[var(--muted)] text-[var(--fg)] rounded-full">${tag}</span>`).join('')}
              </div>
            ` : ''}
          </a>
        </div>
      `).join(''));
    },

    clearSearch() {
      if (this.input) {
        this.input.value = '';
      }
      if (this.clear) {
        this.clear.classList.add('hidden');
      }
      this.hideResults();
    }
  };

  // Event listeners
  const searchInput = document.getElementById('search-input');
  const searchClear = document.getElementById('search-clear');

  if (searchInput && searchClear) {
    searchInput.addEventListener('input', (e) => {
      const value = (e.target as HTMLInputElement).value;
      searchClear.classList.toggle('hidden', value.length === 0);

      // Search functionality will be handled by the search page
      if (window.searchNotes) {
        if (value.length > 0) {
          window.searchBox.showLoading();
          window.searchBox.showResults();
          window.searchNotes(value);
        } else {
          window.searchBox.hideResults();
        }
      }
    });

    searchClear.addEventListener('click', () => {
      window.searchBox.clearSearch();
    });

    // Hide results when clicking outside
    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target as Node) && !window.searchBox.results?.contains(e.target as Node)) {
        window.searchBox.hideResults();
      }
    });
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>


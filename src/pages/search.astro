---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SearchBox from '../components/SearchBox.astro';
import PostCard from '../components/PostCard.astro';
import TagPill from '../components/TagPill.astro';
import { getCollection } from 'astro:content';

const notes = await getCollection('notes');
const publishedNotes = notes.filter(note =>
  note.data.stage === 'published' || !note.data.stage
);

// Create search index data
const searchIndex = publishedNotes.map(note => ({
  slug: note.slug,
  title: note.data.title,
  description: note.data.description || '',
  tags: note.data.tags || [],
  content: note.body || '',
  pubDate: note.data.pubDate
}));

const description = "Search through all notes and find what you're looking for.";
---

<Layout title="Search" description={description}>
  <Header />

  <main id="main" class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-serif font-bold text-[var(--fg)] mb-4">
        Search Notes
      </h1>
      <p class="text-[var(--fg)] opacity-70 mb-8">
        Search through {publishedNotes.length} published notes
      </p>
    </div>

    <!-- Search Box -->
    <div class="mb-8">
      <SearchBox />
    </div>

    <!-- Search Results -->
    <div id="search-results-container" class="hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-serif font-semibold text-[var(--fg)]">
          Search Results
          <span id="results-count" class="text-[var(--accent)] font-normal"></span>
        </h2>
        <button
          id="clear-results"
          class="px-3 py-2 text-sm border border-[var(--muted)] text-[var(--fg)] rounded-lg hover:border-[var(--accent)] hover:text-[var(--accent)] transition-colors"
        >
          Clear
        </button>
      </div>

      <div id="search-results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Results will be populated by JavaScript -->
      </div>
    </div>

    <!-- Popular Tags for Discovery -->
    <div class="mt-12">
      <h2 class="text-2xl font-serif font-semibold text-[var(--fg)] mb-6">
        Popular Topics
      </h2>
      <div class="flex flex-wrap gap-2">
        {(() => {
          const allTags = [...new Set(notes.flatMap(note => note.data.tags || []))];
          const tagCounts = allTags.map(tag => ({
            tag,
            count: publishedNotes.filter(note => note.data.tags?.includes(tag)).length
          })).sort((a, b) => b.count - a.count).slice(0, 12);

          return tagCounts.map(({ tag, count }) => (
            <button
              class="search-tag px-3 py-2 rounded-lg transition-colors font-medium bg-[var(--muted)] text-[var(--fg)] hover:bg-[var(--accent)] hover:text-white"
              data-tag={tag}
            >
              {tag} ({count})
            </button>
          ));
        })()}
      </div>
    </div>

    <!-- Search Tips -->
    <div class="mt-12 p-6 bg-[var(--muted)]/30 rounded-lg">
      <h3 class="font-semibold text-[var(--fg)] mb-3">Search Tips</h3>
      <ul class="text-sm text-[var(--fg)] opacity-70 space-y-1">
        <li>• Search by note title, description, or tags</li>
        <li>• Click on tags above to filter by topic</li>
        <li>• Results are sorted by relevance</li>
        <li>• Only published notes are included in search</li>
      </ul>
    </div>
  </main>

  <!-- Load Search Index from JSON -->
  <script>
    // Load search index from JSON file
    async function loadSearchIndex() {
      try {
        const response = await fetch('/search-index.json');
        const searchIndex = await response.json();
        window.searchIndex = searchIndex;

        // Initialize search functionality
        if (window.searchNotes) {
          const searchInput = document.getElementById('search-input');
          if (searchInput) {
            searchInput.addEventListener('input', (e) => {
              const value = (e.target).value;
              if (value.length > 0) {
                window.searchBox.showLoading();
                window.searchBox.showResults();
                window.searchNotes(value);
              } else {
                window.searchBox.hideResults();
              }
            });
          }
        }
      } catch (error) {
        console.error('Failed to load search index:', error);
      }
    }

    // Load search index on page load
    document.addEventListener('DOMContentLoaded', loadSearchIndex);
  </script>

  <!-- Fuse.js and Search Logic -->
  <script>
    import Fuse from 'fuse.js';

    // Initialize Fuse.js with search configuration
    const fuse = new Fuse(window.searchIndex, {
      keys: [
        { name: 'title', weight: 0.4 },
        { name: 'description', weight: 0.3 },
        { name: 'tags', weight: 0.2 },
        { name: 'content', weight: 0.1 }
      ],
      includeScore: true,
      threshold: 0.3,
      includeMatches: true,
      minMatchCharLength: 2
    });

    // Search function
    window.searchNotes = function(query) {
      if (!query || query.length < 2) {
        window.searchBox.hideResults();
        return;
      }

      const results = fuse.search(query).slice(0, 20); // Limit to 20 results

      // Display results
      displaySearchResults(results);
    };

    // Display search results
    function displaySearchResults(results) {
      const container = document.getElementById('search-results-container');
      const grid = document.getElementById('search-results-grid');
      const count = document.getElementById('results-count');
      const clearBtn = document.getElementById('clear-results');

      if (!container || !grid || !count) return;

      // Clear previous results
      grid.innerHTML = '';

      if (results.length === 0) {
        count.textContent = '';
        container.classList.add('hidden');
        window.searchBox.showNoResults();
        return;
      }

      // Show results container
      container.classList.remove('hidden');
      window.searchBox.hideLoading();

      // Update count
      count.textContent = ` (${results.length} found)`;

      // Add results to grid
      results.forEach(result => {
        const note = result.item;
        const resultDiv = document.createElement('div');
        resultDiv.className = 'search-result-item';
        resultDiv.innerHTML = `
          <article class="bg-[var(--bg)] border border-[var(--muted)] rounded-lg p-4 hover:border-[var(--accent)] transition-colors">
            <div class="flex flex-col h-full">
              <header class="mb-3">
                <h3 class="text-lg font-serif font-semibold text-[var(--fg)] hover:text-[var(--accent)] transition-colors mb-2">
                  <a href="/notes/${note.slug}">
                    ${note.title}
                  </a>
                </h3>
                ${note.description ? `
                  <p class="text-[var(--fg)] opacity-80 text-sm mb-3 line-clamp-2">
                    ${note.description}
                  </p>
                ` : ''}
                ${note.pubDate ? `
                  <time class="text-xs text-[var(--fg)] opacity-60">
                    ${new Date(note.pubDate).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </time>
                ` : ''}
              </header>
              ${note.tags && note.tags.length > 0 ? `
                <div class="flex flex-wrap gap-2 mt-auto">
                  ${note.tags.slice(0, 3).map(tag => `<span class="inline-block px-2 py-1 text-xs bg-[var(--muted)] text-[var(--fg)] rounded-full">${tag}</span>`).join('')}
                  ${note.tags.length > 3 ? `<span class="text-xs text-[var(--fg)] opacity-60 self-center">+${note.tags.length - 3} more</span>` : ''}
                </div>
              ` : ''}
            </div>
          </article>
        `;
        grid.appendChild(resultDiv);
      });

      // Clear button functionality
      if (clearBtn) {
        clearBtn.onclick = function() {
          const searchInput = document.getElementById('search-input');
          if (searchInput) {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
          }
          container.classList.add('hidden');
        };
      }
    }

    // Tag search functionality
    document.addEventListener('DOMContentLoaded', () => {
      const tagButtons = document.querySelectorAll('.search-tag');
      tagButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tag = button.getAttribute('data-tag');
          if (tag) {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
              searchInput.value = tag.split(' ')[0]; // Remove count from tag name
              searchInput.dispatchEvent(new Event('input'));
              searchInput.focus();
            }
          }
        });
      });
    });
  </script>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>

  <Footer />
</Layout>
